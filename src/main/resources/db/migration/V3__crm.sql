-- ============================================================
-- V3: CRM â€“ third parties, contacts, addresses
-- ============================================================

CREATE TABLE addresses (
    id             BIGINT       NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id      VARCHAR(36)  NOT NULL,
    label          VARCHAR(100),
    address_line1  VARCHAR(255) NOT NULL,
    address_line2  VARCHAR(255),
    city           VARCHAR(100) NOT NULL,
    state_province VARCHAR(100),
    postal_code    VARCHAR(20),
    country_code   CHAR(2)      NOT NULL,
    is_billing     BOOLEAN      NOT NULL DEFAULT FALSE,
    is_shipping    BOOLEAN      NOT NULL DEFAULT FALSE,
    CONSTRAINT pk_addresses PRIMARY KEY (id),
    CONSTRAINT fk_addresses_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

CREATE TABLE third_parties (
    id                  BIGINT       NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id           VARCHAR(36)  NOT NULL,
    code                VARCHAR(50)  NOT NULL,
    name                VARCHAR(255) NOT NULL,
    type                VARCHAR(30)  NOT NULL DEFAULT 'CUSTOMER',
    is_customer         BOOLEAN      NOT NULL DEFAULT FALSE,
    is_supplier         BOOLEAN      NOT NULL DEFAULT FALSE,
    is_prospect         BOOLEAN      NOT NULL DEFAULT FALSE,
    legal_form          VARCHAR(100),
    tax_id              VARCHAR(100),
    registration_no     VARCHAR(100),
    website             VARCHAR(255),
    phone               VARCHAR(50),
    fax                 VARCHAR(50),
    email               VARCHAR(255),
    address_line1       VARCHAR(255),
    address_line2       VARCHAR(255),
    city                VARCHAR(100),
    state_province      VARCHAR(100),
    postal_code         VARCHAR(20),
    country_code        CHAR(2),
    billing_address_id  BIGINT,
    shipping_address_id BIGINT,
    currency_code       CHAR(3),
    payment_terms       SMALLINT     DEFAULT 30,
    credit_limit        NUMERIC(19,4),
    balance             NUMERIC(19,4) NOT NULL DEFAULT 0,
    sales_rep_id        BIGINT,
    parent_id           BIGINT,
    notes               TEXT,
    tags                VARCHAR(500),
    status              VARCHAR(30)  NOT NULL DEFAULT 'ACTIVE',
    created_at          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at          TIMESTAMP,
    created_by          BIGINT,
    CONSTRAINT pk_third_parties PRIMARY KEY (id),
    CONSTRAINT fk_tp_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT fk_tp_billing_addr FOREIGN KEY (billing_address_id) REFERENCES addresses(id),
    CONSTRAINT fk_tp_shipping_addr FOREIGN KEY (shipping_address_id) REFERENCES addresses(id),
    CONSTRAINT fk_tp_sales_rep FOREIGN KEY (sales_rep_id) REFERENCES users(id),
    CONSTRAINT fk_tp_parent FOREIGN KEY (parent_id) REFERENCES third_parties(id),
    CONSTRAINT uq_third_parties_tenant_code UNIQUE (tenant_id, code)
);

CREATE TABLE contacts (
    id             BIGINT       NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id      VARCHAR(36)  NOT NULL,
    third_party_id BIGINT,
    civility       VARCHAR(10),
    first_name     VARCHAR(100),
    last_name      VARCHAR(100) NOT NULL,
    job_title      VARCHAR(150),
    department     VARCHAR(100),
    email          VARCHAR(255),
    phone          VARCHAR(50),
    mobile         VARCHAR(50),
    fax            VARCHAR(50),
    address_line1  VARCHAR(255),
    city           VARCHAR(100),
    postal_code    VARCHAR(20),
    country_code   CHAR(2),
    linkedin_url   VARCHAR(255),
    birth_date     DATE,
    notes          TEXT,
    is_primary     BOOLEAN      NOT NULL DEFAULT FALSE,
    opt_in_email   BOOLEAN      NOT NULL DEFAULT FALSE,
    status         VARCHAR(30)  NOT NULL DEFAULT 'ACTIVE',
    created_at     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at     TIMESTAMP,
    CONSTRAINT pk_contacts PRIMARY KEY (id),
    CONSTRAINT fk_contacts_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT fk_contacts_third_party FOREIGN KEY (third_party_id) REFERENCES third_parties(id)
);

CREATE INDEX idx_third_parties_tenant ON third_parties(tenant_id);
CREATE INDEX idx_contacts_tenant      ON contacts(tenant_id);
CREATE INDEX idx_contacts_tp          ON contacts(third_party_id);
