-- ============================================================
-- V5: Commerce â€“ proposals, orders, invoices, payments
-- ============================================================

CREATE TABLE proposals (
    id                    BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id             VARCHAR(36)   NOT NULL,
    reference             VARCHAR(50)   NOT NULL,
    third_party_id        BIGINT        NOT NULL,
    contact_id            BIGINT,
    title                 VARCHAR(255),
    status                VARCHAR(30)   NOT NULL DEFAULT 'DRAFT',
    date_issued           DATE          NOT NULL,
    date_valid_until      DATE,
    currency_code         CHAR(3)       NOT NULL,
    exchange_rate         NUMERIC(19,8) NOT NULL DEFAULT 1,
    subtotal              NUMERIC(19,4) NOT NULL DEFAULT 0,
    discount_amount       NUMERIC(19,4) NOT NULL DEFAULT 0,
    vat_amount            NUMERIC(19,4) NOT NULL DEFAULT 0,
    total_amount          NUMERIC(19,4) NOT NULL DEFAULT 0,
    notes                 TEXT,
    terms                 TEXT,
    sales_rep_id          BIGINT,
    converted_to_order_id BIGINT,
    created_at            TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by            BIGINT,
    CONSTRAINT pk_proposals PRIMARY KEY (id),
    CONSTRAINT fk_proposals_tenant      FOREIGN KEY (tenant_id)      REFERENCES tenants(id),
    CONSTRAINT fk_proposals_tp          FOREIGN KEY (third_party_id) REFERENCES third_parties(id),
    CONSTRAINT fk_proposals_contact     FOREIGN KEY (contact_id)     REFERENCES contacts(id),
    CONSTRAINT fk_proposals_currency    FOREIGN KEY (currency_code)  REFERENCES currencies(code),
    CONSTRAINT fk_proposals_sales_rep   FOREIGN KEY (sales_rep_id)   REFERENCES users(id),
    CONSTRAINT uq_proposals_ref         UNIQUE (tenant_id, reference)
);

CREATE TABLE proposal_lines (
    id           BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id    VARCHAR(36)   NOT NULL,
    proposal_id  BIGINT        NOT NULL,
    product_id   BIGINT,
    sort_order   SMALLINT      NOT NULL DEFAULT 0,
    description  VARCHAR(500)  NOT NULL,
    quantity     NUMERIC(19,4) NOT NULL,
    unit_price   NUMERIC(19,4) NOT NULL,
    discount_pct NUMERIC(6,4)  NOT NULL DEFAULT 0,
    vat_rate     NUMERIC(6,4)  NOT NULL DEFAULT 0,
    line_total   NUMERIC(19,4) NOT NULL,
    currency_code CHAR(3)      NOT NULL,
    CONSTRAINT pk_proposal_lines PRIMARY KEY (id),
    CONSTRAINT fk_pl_tenant   FOREIGN KEY (tenant_id)   REFERENCES tenants(id),
    CONSTRAINT fk_pl_proposal FOREIGN KEY (proposal_id) REFERENCES proposals(id),
    CONSTRAINT fk_pl_product  FOREIGN KEY (product_id)  REFERENCES products(id)
);

CREATE TABLE sales_orders (
    id                  BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id           VARCHAR(36)   NOT NULL,
    reference           VARCHAR(50)   NOT NULL,
    proposal_id         BIGINT,
    third_party_id      BIGINT        NOT NULL,
    contact_id          BIGINT,
    status              VARCHAR(30)   NOT NULL DEFAULT 'CONFIRMED',
    date_ordered        DATE          NOT NULL,
    date_expected       DATE,
    date_delivered      DATE,
    currency_code       CHAR(3)       NOT NULL,
    exchange_rate       NUMERIC(19,8) NOT NULL DEFAULT 1,
    subtotal            NUMERIC(19,4) NOT NULL DEFAULT 0,
    discount_amount     NUMERIC(19,4) NOT NULL DEFAULT 0,
    vat_amount          NUMERIC(19,4) NOT NULL DEFAULT 0,
    total_amount        NUMERIC(19,4) NOT NULL DEFAULT 0,
    shipping_address_id BIGINT,
    notes               TEXT,
    terms               TEXT,
    sales_rep_id        BIGINT,
    created_at          TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by          BIGINT,
    CONSTRAINT pk_sales_orders PRIMARY KEY (id),
    CONSTRAINT fk_so_tenant   FOREIGN KEY (tenant_id)      REFERENCES tenants(id),
    CONSTRAINT fk_so_proposal FOREIGN KEY (proposal_id)    REFERENCES proposals(id),
    CONSTRAINT fk_so_tp       FOREIGN KEY (third_party_id) REFERENCES third_parties(id),
    CONSTRAINT fk_so_contact  FOREIGN KEY (contact_id)     REFERENCES contacts(id),
    CONSTRAINT fk_so_currency FOREIGN KEY (currency_code)  REFERENCES currencies(code),
    CONSTRAINT uq_sales_orders_ref UNIQUE (tenant_id, reference)
);

CREATE TABLE sales_order_lines (
    id                 BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id          VARCHAR(36)   NOT NULL,
    order_id           BIGINT        NOT NULL,
    product_id         BIGINT,
    sort_order         SMALLINT      NOT NULL DEFAULT 0,
    description        VARCHAR(500)  NOT NULL,
    quantity           NUMERIC(19,4) NOT NULL,
    quantity_delivered NUMERIC(19,4) NOT NULL DEFAULT 0,
    unit_price         NUMERIC(19,4) NOT NULL,
    discount_pct       NUMERIC(6,4)  NOT NULL DEFAULT 0,
    vat_rate           NUMERIC(6,4)  NOT NULL DEFAULT 0,
    line_total         NUMERIC(19,4) NOT NULL,
    CONSTRAINT pk_sales_order_lines PRIMARY KEY (id),
    CONSTRAINT fk_sol_tenant  FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT fk_sol_order   FOREIGN KEY (order_id)  REFERENCES sales_orders(id),
    CONSTRAINT fk_sol_product FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE purchase_orders (
    id             BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id      VARCHAR(36)   NOT NULL,
    reference      VARCHAR(50)   NOT NULL,
    third_party_id BIGINT        NOT NULL,
    contact_id     BIGINT,
    status         VARCHAR(30)   NOT NULL DEFAULT 'DRAFT',
    date_ordered   DATE          NOT NULL,
    date_expected  DATE,
    date_received  DATE,
    currency_code  CHAR(3)       NOT NULL,
    exchange_rate  NUMERIC(19,8) NOT NULL DEFAULT 1,
    subtotal       NUMERIC(19,4) NOT NULL DEFAULT 0,
    vat_amount     NUMERIC(19,4) NOT NULL DEFAULT 0,
    total_amount   NUMERIC(19,4) NOT NULL DEFAULT 0,
    notes          TEXT,
    created_at     TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by     BIGINT,
    CONSTRAINT pk_purchase_orders PRIMARY KEY (id),
    CONSTRAINT fk_po_tenant   FOREIGN KEY (tenant_id)      REFERENCES tenants(id),
    CONSTRAINT fk_po_tp       FOREIGN KEY (third_party_id) REFERENCES third_parties(id),
    CONSTRAINT fk_po_contact  FOREIGN KEY (contact_id)     REFERENCES contacts(id),
    CONSTRAINT fk_po_currency FOREIGN KEY (currency_code)  REFERENCES currencies(code),
    CONSTRAINT uq_purchase_orders_ref UNIQUE (tenant_id, reference)
);

CREATE TABLE purchase_order_lines (
    id                BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id         VARCHAR(36)   NOT NULL,
    order_id          BIGINT        NOT NULL,
    product_id        BIGINT,
    sort_order        SMALLINT      NOT NULL DEFAULT 0,
    description       VARCHAR(500)  NOT NULL,
    quantity          NUMERIC(19,4) NOT NULL,
    quantity_received NUMERIC(19,4) NOT NULL DEFAULT 0,
    unit_price        NUMERIC(19,4) NOT NULL,
    vat_rate          NUMERIC(6,4)  NOT NULL DEFAULT 0,
    line_total        NUMERIC(19,4) NOT NULL,
    CONSTRAINT pk_purchase_order_lines PRIMARY KEY (id),
    CONSTRAINT fk_pol_tenant  FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    CONSTRAINT fk_pol_order   FOREIGN KEY (order_id)  REFERENCES purchase_orders(id),
    CONSTRAINT fk_pol_product FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE invoices (
    id                BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id         VARCHAR(36)   NOT NULL,
    reference         VARCHAR(50)   NOT NULL,
    type              VARCHAR(30)   NOT NULL,
    third_party_id    BIGINT        NOT NULL,
    contact_id        BIGINT,
    sales_order_id    BIGINT,
    purchase_order_id BIGINT,
    status            VARCHAR(30)   NOT NULL DEFAULT 'DRAFT',
    date_issued       DATE          NOT NULL,
    date_due          DATE          NOT NULL,
    currency_code     CHAR(3)       NOT NULL,
    exchange_rate     NUMERIC(19,8) NOT NULL DEFAULT 1,
    subtotal          NUMERIC(19,4) NOT NULL DEFAULT 0,
    discount_amount   NUMERIC(19,4) NOT NULL DEFAULT 0,
    vat_amount        NUMERIC(19,4) NOT NULL DEFAULT 0,
    total_amount      NUMERIC(19,4) NOT NULL DEFAULT 0,
    amount_paid       NUMERIC(19,4) NOT NULL DEFAULT 0,
    amount_remaining  NUMERIC(19,4) NOT NULL DEFAULT 0,
    notes             TEXT,
    terms             TEXT,
    payment_method    VARCHAR(50),
    bank_account      VARCHAR(100),
    created_at        TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    validated_at      TIMESTAMP,
    validated_by      BIGINT,
    created_by        BIGINT,
    CONSTRAINT pk_invoices PRIMARY KEY (id),
    CONSTRAINT fk_inv_tenant    FOREIGN KEY (tenant_id)        REFERENCES tenants(id),
    CONSTRAINT fk_inv_tp        FOREIGN KEY (third_party_id)   REFERENCES third_parties(id),
    CONSTRAINT fk_inv_contact   FOREIGN KEY (contact_id)       REFERENCES contacts(id),
    CONSTRAINT fk_inv_so        FOREIGN KEY (sales_order_id)   REFERENCES sales_orders(id),
    CONSTRAINT fk_inv_po        FOREIGN KEY (purchase_order_id) REFERENCES purchase_orders(id),
    CONSTRAINT fk_inv_currency  FOREIGN KEY (currency_code)    REFERENCES currencies(code),
    CONSTRAINT uq_invoices_ref  UNIQUE (tenant_id, reference)
);

CREATE TABLE invoice_lines (
    id           BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id    VARCHAR(36)   NOT NULL,
    invoice_id   BIGINT        NOT NULL,
    product_id   BIGINT,
    sort_order   SMALLINT      NOT NULL DEFAULT 0,
    description  VARCHAR(500)  NOT NULL,
    quantity     NUMERIC(19,4) NOT NULL,
    unit_price   NUMERIC(19,4) NOT NULL,
    discount_pct NUMERIC(6,4)  NOT NULL DEFAULT 0,
    vat_rate     NUMERIC(6,4)  NOT NULL DEFAULT 0,
    line_total   NUMERIC(19,4) NOT NULL,
    CONSTRAINT pk_invoice_lines PRIMARY KEY (id),
    CONSTRAINT fk_il_tenant  FOREIGN KEY (tenant_id)  REFERENCES tenants(id),
    CONSTRAINT fk_il_invoice FOREIGN KEY (invoice_id) REFERENCES invoices(id),
    CONSTRAINT fk_il_product FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE payments (
    id             BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    tenant_id      VARCHAR(36)   NOT NULL,
    invoice_id     BIGINT        NOT NULL,
    amount         NUMERIC(19,4) NOT NULL,
    currency_code  CHAR(3)       NOT NULL,
    exchange_rate  NUMERIC(19,8) NOT NULL DEFAULT 1,
    payment_date   DATE          NOT NULL,
    payment_method VARCHAR(50)   NOT NULL,
    reference      VARCHAR(100),
    notes          TEXT,
    created_at     TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by     BIGINT,
    CONSTRAINT pk_payments PRIMARY KEY (id),
    CONSTRAINT fk_pay_tenant   FOREIGN KEY (tenant_id)   REFERENCES tenants(id),
    CONSTRAINT fk_pay_invoice  FOREIGN KEY (invoice_id)  REFERENCES invoices(id),
    CONSTRAINT fk_pay_currency FOREIGN KEY (currency_code) REFERENCES currencies(code)
);

CREATE INDEX idx_proposals_tenant    ON proposals(tenant_id);
CREATE INDEX idx_sales_orders_tenant ON sales_orders(tenant_id);
CREATE INDEX idx_invoices_tenant     ON invoices(tenant_id);
CREATE INDEX idx_invoices_type       ON invoices(tenant_id, type, status);
CREATE INDEX idx_invoices_tp         ON invoices(tenant_id, third_party_id);
